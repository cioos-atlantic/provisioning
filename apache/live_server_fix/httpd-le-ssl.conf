<IfModule mod_ssl.c>
<VirtualHost *:443>
	Protocols h2 h2c http/1.1
        ServerName cioosatlantic.ca
        ServerAlias cioosatlantic.ca
        DocumentRoot /var/www/html

	RewriteEngine on
	RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
	RewriteRule ^ https://cioosatlantic.ca%{REQUEST_URI} [END,NE,R=permanent,L]
	
	<Location "/">
		Options None
		Require all granted
		
		## Request header rules
	       	## as per http://httpd.apache.org/docs/2.2/mod/mod_headers.html#requestheader
	        RequestHeader set X-Forwarded-Proto "https"
		# add X-FORWARDED-FOR & X-CLIENT-IP
	        #option forwardfor http-request add-header X-CLIENT-IP %[src]
		#RemoteIPHeader X-Forwarded-For
		#RemoteIPHeader X-Client-IP
		#RemoteIPProxiesHeader X-Forwarded-By
		## Proxy Rules
	       	#ProxyRequests Off
	        ProxyPreserveHost On
	       	ProxyPass http://127.0.0.1:8500/
	        ProxyPassReverse http://127.0.0.1:8500/
	</Location>
	<Location "/wp-admin">
		Options None
		Require all granted
	</Location>
	
	# CKAN
	<Location "/ckan">
		RedirectMatch ^/ckan/(.*) https://catalogue.cioosatlantic.ca/$1
		#ProxyPreserveHost Off
	      	#ProxyPass http://127.0.0.1:5000
	        #ProxyPassReverse http://127.0.0.1:5000
		Header set Access-Control-Allow-Origin "*"
		Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
                Header set Access-Control-Allow-Headers "x-requested-with"
		#AuthType Basic
	        #AuthName "Restricted Content"
	        #AuthUserFile /etc/httpd/.htpasswd
		#Require valid-user
		<IfModule mod_deflate.c>
        		AddOutputFilterByType DEFLATE text/css text/x-component application/x-javascript application/javascript text/javascript text/x-js text/html text/richtext text/plain text/xsd text/xsl text/xml image/bmp application/java application/msword application/vnd.ms-fontobject application/x-msdownload image/x-icon application/json application/vnd.ms-access video/webm application/vnd.ms-project application/x-font-otf application/vnd.ms-opentype application/vnd.oasis.opendocument.database application/vnd.oasis.opendocument.chart application/vnd.oasis.opendocument.formula application/vnd.oasis.opendocument.graphics application/vnd.oasis.opendocument.presentation application/vnd.oasis.opendocument.spreadsheet application/vnd.oasis.opendocument.text audio/ogg application/pdf application/vnd.ms-powerpoint image/svg+xml application/x-shockwave-flash image/tiff application/x-font-ttf application/vnd.ms-opentype audio/wav application/vnd.ms-write application/font-woff application/font-woff2 application/vnd.ms-excel
    			<IfModule mod_mime.c>
        			# DEFLATE by extension
        			AddOutputFilter DEFLATE js css htm html xml
    			</IfModule> 
		</IfModule>
	</Location>
	<Location "/ckan/csw">
		# pycsw
		ProxyPass http://127.0.0.1:8000/pycsw/csw.js
		ProxyPassReverse http://127.0.0.1:8000/pycsw/csw.js
 	</Location>
	<Location "/erddap">
		ProxyPreserveHost Off
	        ProxyPass http://127.0.0.1:8080/erddap
		ProxyPassReverse http://127.0.0.1:8080/erddap

		# Adding header to enable CORS access at this 
		# stage rather than modifying the Tomcat configuration
		Header set Access-Control-Allow-Origin "*"

	        #AuthType Basic
		#AuthName "Restricted Content"
	        #AuthUserFile /etc/httpd/.htpasswd
		#Require valid-user
	</Location>	

        # Asset Map
        <Location "/assetmap/asset">
                ProxyPreserveHost Off
                ProxyPass http://127.0.0.1:8009/asset
                ProxyPassReverse http://127.0.0.1:8009/asset
        </Location>

	<Location "/phytofit">
                Header always set Strict-Transport-Security "max-age=31536000; includeSubdomains;"

                # Adding CORS header to Apache to avoid reconfiguring Tomcat
                # to provide the same functionality
                Header set Access-Control-Allow-Origin "*"

                ProxyPreserveHost Off
                ProxyPass http://127.0.0.1:3838/phytofit
                ProxyPassReverse http://127.0.0.1:3838/phytofit
        </Location>

        # Debug Asset Map
        <Location "/debugmap/asset">
                ProxyPreserveHost Off
                ProxyPass http://127.0.0.1:8008/asset
                ProxyPassReverse http://127.0.0.1:8008/asset
                AuthType Basic
                AuthName "Restricted Content"
                AuthUserFile /etc/httpd/.htpasswd
                Require valid-user
        </Location>


	# Matomo
        #<Location "/matomo">
        #        ProxyPreserveHost Off
        #        ProxyPass http://127.0.0.1:9000
        #        ProxyPassReverse http://127.0.0.1:9000
        #        AuthType Basic
        #        AuthName "Restricted Content"
        #        AuthUserFile /etc/httpd/.htpasswd
        #        Require valid-user
        #</Location>

	Include /etc/letsencrypt/options-ssl-apache.conf
	ServerAlias www.cioosatlantic.ca
	SSLCertificateFile /etc/letsencrypt/live/cioosatlantic.ca/fullchain.pem
	SSLCertificateKeyFile /etc/letsencrypt/live/cioosatlantic.ca/privkey.pem
</VirtualHost>

<VirtualHost *:443>
	Protocols h2 h2c http/1.1
        ServerName catalogue.cioosatlantic.ca
        ServerAlias catalogue.cioosatlantic.ca
        #DocumentRoot /var/www/html3

        #RewriteEngine on
        #RewriteCond %{SERVER_NAME} =catalogue.cioosatlantic.ca
        ##RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
        #RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE]

        #<Location "/">
        #        Options None
        #        Require all granted
        #
        #        ## Request header rules
        #        ## as per http://httpd.apache.org/docs/2.2/mod/mod_headers.html#requestheader
        #        RequestHeader set X-Forwarded-Proto "https"
        #        ## Proxy Rules
        #        #ProxyRequests Off
        #        ProxyPreserveHost On
        #        ProxyPass http://127.0.0.1:8500/
        #        ProxyPassReverse http://127.0.0.1:8500/
        #</Location>

        # CKAN
        <Location "/">
                ProxyPreserveHost Off
                #ProxyPass http://192.168.29.71:5000/
		#ProxyPassReverse http://192.168.29.71:5000/
		ProxyPass http://ca-prod-ckan.arbutus:5000/
                ProxyPassReverse http://ca-prod-ckan.arbutus:5000/
                Header set Access-Control-Allow-Origin "*"
		Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
	        Header set Access-Control-Allow-Headers "x-requested-with"
                #AuthType Basic
                #AuthName "Restricted Content"
                #AuthUserFile /etc/httpd/.htpasswd
                #Require valid-user
        </Location>
        # pycsw
        #<Location "/csw">
        #       ProxyPass http://127.0.0.1:8000/pycsw/csw.js
        #       ProxyPassReverse http://127.0.0.1:8000/pycsw/csw.js
        #</Location>

	Include /etc/letsencrypt/options-ssl-apache.conf
	SSLCertificateFile /etc/letsencrypt/live/cioosatlantic.ca/fullchain.pem
	SSLCertificateKeyFile /etc/letsencrypt/live/cioosatlantic.ca/privkey.pem
</VirtualHost>

<VirtualHost *:443>
	Protocols h2 h2c http/1.1
        ServerName assetmap.cioosatlantic.ca
        ServerAlias assetmap.cioosatlantic.ca
        #DocumentRoot /var/www/html3

        # Assetmap new
        <Location "/">
                ProxyPreserveHost Off
		#ProxyPass http://192.168.29.71:8009/
                #ProxyPassReverse http://192.168.29.71:8009/
                ProxyPass http://ca-prod-ckan.arbutus:8009/
                ProxyPassReverse http://ca-prod-ckan.arbutus:8009/
                #Header set Access-Control-Allow-Origin "*"
                #Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
                #Header set Access-Control-Allow-Headers "x-requested-with"
                #AuthType Basic
                #AuthName "Restricted Content"
                #AuthUserFile /etc/httpd/.htpasswd
                #Require valid-user
        </Location>

        Include /etc/letsencrypt/options-ssl-apache.conf
        SSLCertificateFile /etc/letsencrypt/live/cioosatlantic.ca/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/cioosatlantic.ca/privkey.pem
</VirtualHost>


</IfModule>
